name: Base Pipeline Tests

on:
  workflow_call:
    inputs:
      THREADS:
        required: true
        type: string
      ALLURE_REPORT_NAME:
        required: true
        type: string
      ALLURE_REPORT_DEPLOY_FOLDER:
        required: true
        type: string
      TEST_SUITE:
        required: false
        type: string
        default: 'testng.xml'
      SEND_EMAIL:
        required: false
        type: string
        default: 'false'
      EMAIL_TITLE:
        required: false
        type: string
      EMAIL_RECIPIENTS:
        required: false
        type: string
        default: 'dasguptadhiman5@gmail.com'

jobs:
  execute-tests-and-generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # ‚úÖ required for gh-pages deployment
      pages: write        # ‚úÖ required for Pages
      id-token: write     # ‚úÖ required for OIDC authentication
    timeout-minutes: 300
    outputs:
      report-path: ${{ steps.construct_path.outputs.report-path }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js (latest version)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Cache Maven Packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: Run tests
        id: run-tests
        run: mvn clean test -Dsurefire.suiteXmlFiles=testng.xml
        continue-on-error: true

      - name: Re-run failed tests
        if: ${{ steps.run-tests.outcome == 'failure' && inputs.RERUN_FAILED_TESTS == 'true' }}
        run: |
          if [ ! -f target/surefire-reports/testng-failed.xml ]; then
            echo "No failed tests to rerun."
            exit 0
          fi
            
          sed -E -i 's/thread-count="[0-9]+"/thread-count="${{ inputs.RERUN_FAILED_TESTS_THREADS }}"/g; s/name="Failed suite \[(.*?)\]"/name="\1"/g; s/\(failed\)//g' target/surefire-reports/testng-failed.xml
          mvn verify -q -Dsurefire.suiteXmlFiles=target/surefire-reports/testng-failed.xml -Denv=${{ inputs.ENV }} -Dselenide.headless=true -s settings.xml
        continue-on-error: true

      - name: Checkout gh-pages for history
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Extract filename without extension
        run: |
          FILENAME=$(basename "${{ inputs.TEST_SUITE }}" .xml)
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      - name: Generate Allure Report
        uses: andgineer/allure-report@v3.4
        id: allure-report
        if: always()
        with:
          allure-results: /target/allure-results
          website: gh-pages
          reports-site-path: ${{ inputs.ENV }}/${{ env.FILENAME }}
          max-reports: 10

      - name: Deploy Allure report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: ${{ always() && steps.allure-report.outcome == 'success ' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ./target/allure-report
          destination_dir: ${{ github.run_number }}

      - name: Construct Report Path
        id: construct-path
        run: |
          echo "report-path=${{ steps.allure-report.outputs.reports-site-path }}/${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "REPORT_PATH=${{ steps.allure-report.outputs.reports-site-path }}/${{ github.run_number }}" >> $GITHUB_ENV

      - name: Publish Allure report link
        if: ${{ always() && steps.allure-report.outcome == 'success' }}
        uses: actions/github-script@v7
        with:
          script: |
            const allureReportLink = https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/
            console.log(Allure Report link: ${ allureReportLink })
            const issueBody = [Allure report](${ allureReportLink })
            const newIssue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[${{ inputs.ENV }}] ${{ inputs.ALLURE_REPORT_NAME }} #${{ github.run_number }}',
              body: issueBody
            })

      - name: Upload Allure report files to artifacts
        if: ${{ always() && steps.allure-report.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-folder
          path: ./gh-pages/${{ env.REPORT_PATH }}
          retention-days: 3

      - name: Upload Allure Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/allure-report

  send-email:
    needs: execute-tests-and-generate-report
    runs-on: ubuntu-latest
    if: ${{ always() && !contains(needs.*.result, 'failure') && !contains(needs.*.result, 'cancelled') && inputs.SEND_EMAIL == 'true' }}
    steps:
      - name: Download folder artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report-folder
          path: ./downloaded-artifacts

      - name: Install jq (if necessary)
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Extract test details from Allure report
        if: always()
        id: extract-test-details
        run: |
          set -e

          SUMMARY=$(jq -e '{total: .statistic.total, passed: .statistic.passed, failed: .statistic.failed, skipped: .statistic.skipped, broken: .statistic.broken, unknown: .statistic.unknown, duration: .time.duration | tostring}' ./target/allure-report/widgets/summary.json || echo '{}')

          DURATION_MS=$(echo $SUMMARY | jq -r .duration)
          DURATION=$((DURATION_MS / 1000))
          HOURS=$((DURATION / 3600))
          MINUTES=$(( (DURATION % 3600) / 60 ))
          SECONDS=$((DURATION % 60))
          FORMATTED_DURATION=$(printf "%02d:%02d:%02d" $HOURS $MINUTES $SECONDS)

          TOTAL_SCENARIOS=$(echo "$SUMMARY" | jq -r .total)
          PASSED=$(echo "$SUMMARY" | jq -r .passed)
          FAILED=$(echo "$SUMMARY" | jq -r .failed)
          SKIPPED=$(echo "$SUMMARY" | jq -r .skipped)
          BROKEN=$(echo "$SUMMARY" | jq -r .broken)
          UNKNOWN=$(echo "$SUMMARY" | jq -r .unknown)

          echo "TOTAL_SCENARIOS=$TOTAL_SCENARIOS" >> $GITHUB_ENV
          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "BROKEN=$BROKEN" >> $GITHUB_ENV
          echo "UNKNOWN=$UNKNOWN" >> $GITHUB_ENV
          echo "DURATION=$FORMATTED_DURATION" >> $GITHUB_ENV
          echo "EXECUTION_DATETIME=$(date)" >> $GITHUB_ENV

          if [ "$TOTAL_SCENARIOS" -gt 0 ]; then
            PASS_RATE=$((PASSED * 100 / TOTAL_SCENARIOS))
          else
            PASS_RATE=0
          fi

          echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV

          if [ "$FAILED" -gt 0 ]; then
            FAILED_TESTS=$(jq -e '[.. | select(.name? | type == "string" and contains(".")) | {test: .name, test_cases: [.children[]? | select(.status == "failed") | .name]}] | map(select(.test_cases | length > 0))' ./target/allure-report/data/suites.json || echo '[]')
            jq -e '[.. | select(.name? | type == "string" and contains(".")) | {error_message: .name, "test_case": ([.children[]?.name])}]' ./target/allure-report/data/categories.json > failed_messages.json || echo '[]' > failed_messages.json
            echo "HAS_FAILED_TESTS=true" >> $GITHUB_ENV
            echo "FAILED_TESTS=$(echo "$FAILED_TESTS" | jq -c .)" >> $GITHUB_ENV
          else
            echo "HAS_FAILED_TESTS=false" >> $GITHUB_ENV
            echo "FAILED_TESTS=[]" >> $GITHUB_ENV
            echo "FAILED_MESSAGES=[]" >> $GITHUB_ENV
          fi

      - name: Debug extracted test details
        run: |
          echo "Debugging extracted Allure metrics..."
          echo "TOTAL_SCENARIOS=$TOTAL_SCENARIOS"
          echo "PASSED=$PASSED"
          echo "FAILED=$FAILED"
          echo "SKIPPED=$SKIPPED"
          echo "BROKEN=$BROKEN"
          echo "UNKNOWN=$UNKNOWN"
          echo "DURATION=$DURATION"
          echo "PASS_RATE=$PASS_RATE"
          echo "EXECUTION_DATETIME=$EXECUTION_DATETIME"
          echo "HAS_FAILED_TESTS=$HAS_FAILED_TESTS"
          echo "FAILED_TESTS=$FAILED_TESTS"

      - name: Generate Email Body
        id: generate-email-body
        run: |
          REPORT_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${{ github.run_number }}/"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          EMAIL_BODY=$(cat <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>Test Summary Report</title>
          </head>
          <body style="font-family: Arial, sans-serif; background:#f7f9fc; padding:20px;">
            <h2 style="color:#2c3e50;">Flipkart Regression - Run #${{ github.run_number }}</h2>

            <div style="display:flex;gap:20px;">
              <div>
                <img src="https://quickchart.io/chart?c={
                  type:'doughnut',
                  data:{
                    labels:['Passed','Failed','Skipped','Broken'],
                    datasets:[{
                      data:[${{ env.PASSED || 0 }},${{ env.FAILED || 0 }},${{ env.SKIPPED || 0 }},${{ env.BROKEN || 0 }}],
                      backgroundColor:['#97cc64','#fd5a3e','#aaa','#ffd050']
                    }]
                  }
                }" width="300">
              </div>

              <div style="background:#fff;padding:15px;border:1px solid #ddd;border-radius:8px;">
                <p><b>Total Scenarios:</b> $TOTAL_SCENARIOS</p>
                <p>‚úÖ <b>Passed:</b> $PASSED</p>
                <p>‚ùå <b>Failed:</b> $FAILED</p>
                <p>‚è∏Ô∏è <b>Skipped:</b> $SKIPPED</p>
                <p>üêõ <b>Broken:</b> $BROKEN</p>
                <p>üåê <b>Environment:</b> ${ENVIRONMENT:-DEV}</p>
                <p>üïí <b>Test Duration:</b> $DURATION</p>
              </div>
            </div>

            <hr style="margin:20px 0;">

            <div style="text-align:center;">
              <a href="$REPORT_URL" style="background:#3498db;color:#fff;padding:12px 24px;text-decoration:none;border-radius:5px;margin:0 10px;">View Full Report</a>
              <a href="$RUN_URL" style="background:#2ecc71;color:#fff;padding:12px 24px;text-decoration:none;border-radius:5px;margin:0 10px;">GitHub Action Run</a>
            </div>

            <div style="margin-top:30px;font-size:12px;color:#888;text-align:center;">
              <p>&copy; 2025 Flipkart Regression Automation</p>
            </div>
          </body>
          </html>
          EOF
          )

          echo "EMAIL_BODY<<EOF" >> $GITHUB_ENV
          echo "$EMAIL_BODY" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

        env:
          PASSED: ${{ env.PASSED }}
          FAILED: ${{ env.FAILED }}
          SKIPPED: ${{ env.SKIPPED }}
          BROKEN: ${{ env.BROKEN }}
          TOTAL_SCENARIOS: ${{ env.TOTAL_SCENARIOS }}
          DURATION: ${{ env.DURATION }}
          ENVIRONMENT: ${{ inputs.ENV }}

      - name: Send notification email
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Flipkart Regression - Run #${{ github.run_number }}"
          to: ${{ secrets.REPORT_TO }}
          from: ${{ secrets.SMTP_USERNAME }}
          content_type: text/html
          html_body: |
            ${{ env.EMAIL_BODY }}

  cleanup:
    needs: [test, send-email]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Cleanup workspace
        run: |
          echo "Cleaning up workspace..."
          rm -rf ${{ github.workspace }}
